# CLAUDE.md

## 重要な制約事項

- **言語**: ユーザーとのやりとり、プログラム中のコメント、コミットメッセージ、Pull Requestの内容は日本語で記述する
- **CLIコマンド**: フルパスを利用して実行する

## プロジェクト構成

### フォルダ構造
```text
root/
├── src/                 # プログラミングコードを実装するフォルダ
├── docs/                # ドキュメントが格納されているフォルダ
│   └── specification.md # 仕様書
├── CLAUDE.md            # ClaudeCodeへの指示が書かれているファイル
└── README.md            # このプロジェクトのREADME
```

### 技術構成
- **プログラミング言語**: Go v1.24.4
- **静的解析**: golangci-lint (`golangci-lint run ./src/`)

## 開発ワークフロー

### 基本的な実装手順

1. **ブランチ準備**
   ```bash
   git switch main && git pull origin main
   git checkout -b [作業内容に沿ったブランチ名]
   ```

2. **TDD実装（TODO1つごとのサイクル）**
   **重要**: TODOリストから**1つずつ**取り出し、以下の手順を**必ず完了させてから次のTODOに進む**：
   
   **TODO単位の作業サイクル**：
   1. `TodoRead`でTODOリストを確認し、次の1つを選択
   2. 選択したTODOを`in_progress`にマーク
   3. テストコード作成（対応するTODOを明記）
      - **ファイル対応ルール**: 実装ファイル1つに対してテストファイル1つの厳密な1:1対応
        - 例: `user.go` → `user_test.go`、`money.go` → `money_test.go`
        - **禁止**: 複数の実装ファイルを1つのテストファイルでテストすること
        - **禁止**: 1つの実装ファイルを複数のテストファイルに分割すること
        - **統合ルール**: 関連する複数クラスが同一ファイルにある場合、そのテストも同一ファイルに統合
   4. テスト実行（失敗確認）
   5. 実装
   6. テスト成功確認
   7. **品質チェックと即時対応**:
      - golangci-lint実行（フルパス: `golangci-lint run ./src/`）
      - 検出されたissueは**即座に修正**（TODOリストに追加せず、その場で対応）
      - 全てのissueが解消されるまで次に進まない
      - issueが0件になったことを確認
   8. 現在のTODOを`completed`にマーク
   9. **必須コミット**: 1つのTODO完了ごとに必ずコミット（複数TODO分をまとめてコミットすることを禁止）
   10. 次のTODOへ（手順1に戻る）
   
   **禁止事項**：
   - 複数のTODOを同時に`in_progress`にすること
   - コミットせずに次のTODOに進むこと
   - 複数TODO分の変更を1つのコミットにまとめること

3. **品質確認と完了確認**
   - テストカバレッジ確認（目標：80%以上）
   - golangci-lint最終実行（問題がないことを確認）
   - **完了前最終チェック**: `TodoRead`ツールで全項目が`completed`であることを確認
   - **完了条件**: 全TODOリストが空になるか、全て`completed`状態になるまで作業継続
   - プルリクエスト作成

### 作業時の重要原則

- **CLIフルパス**: CLIツール利用時にパスを入力する場合はフルパスで入力
- **既存ファイル優先**: 新規ファイル作成より既存ファイル編集を優先
- **ファイル構成ルール**: 
  - 実装ファイルとテストファイルは必ず1:1対応
  - テストファイル名は実装ファイル名+`_test`（例: `user.go` → `user_test.go`）
  - 複数のテストファイルが同じ実装をテストしている場合は統合必須
  - 1つのテストファイルで複数の実装ファイルをテストしている場合は分割必須
- **TODOリスト活用**: 作業項目を明確にし、完了確認を徹底
- **TODOリスト必須ルール**: 
  - 各作業段階で`TodoRead`ツールを実行し進捗確認
  - 優先度に関係なく、TODOリストの全項目は必須作業として扱う
  - `priority:"low"`であってもリファクタリング含めて必ず完了させる
  - 作業完了報告前に全項目が`completed`であることを必ず確認
- **TODO単位作業の徹底**:
  - 1つのTODOごとに必ずコミット（まとめてコミット禁止）
  - 同時に複数TODOを`in_progress`にすることを禁止
  - 各TODO完了時にgolangci-lint実行とissue即時修正
  - コミットメッセージは完了したTODO内容を明記
- **コメントルール**: 仕様はメソッドコメントとして残し、リファクタリング経緯等の歴史的コメントは削除
- **テスト関数名とコメントルール**: 
  - **テスト関数名**: 英語で記述（例：`TestEquality`, `TestMultiplication`）
  - **テスト関数コメント**: 必須記述、以下の形式で記述
    ```go
    // TestEquality tests Money.Equals method behavior
    // 期待: 同じ金額と通貨の場合は等しく、異なる場合は等しくないと判定される
    func TestEquality(t *testing.T) { ... }
    ```
  - **t.Runのテスト名**: **必ず日本語**で記述
  - 条件と期待結果を含める（例：「5と10を加算した場合、15が返される」）
  - テーブル駆動テストでも同じルールを適用
- **実装ステップ遵守**: 新機能・リファクタリング共にブランチ作成→テスト→実装の手順を適用
- **テストファースト**: 実装前にテストで期待する動作を先に定義
- **既存テスト保護**: 仕様変更せず内部実装のみ改善
- **品質即時対応ルール**:
  - TODO完了ごとにgolangci-lint実行を必須化
  - 検出されたissueは即座に修正（後回し禁止）
  - issue 0件確認後にのみコミット許可
  - 「リファクタリング対象」としてTODOリストに追加することを禁止

## リファクタリング指針

### 重複コード判定基準（50行未満）
duplicツールで検出されない小規模な重複に対する基準：
- **完全重複**: 同じロジックが複数箇所に存在する場合は統合
- **冗長ラッパー**: 型変換のみで追加ロジックがないメソッドは削除対象
- **不要メソッド**: 基底クラス機能と同等で価値を追加しないメソッドは削除

### 推奨golangci-lintツール
- **dupl**: 重複コード検出
- **gocyclo**: 循環的複雑度測定
- **cyclop**: 関数・パッケージ複雑度チェック

詳細設定は [README.md](./README.md#推奨ツールリファクタリング対象検出用) と `.golangci.yml` を参照。

## テストファイル対応強化ルール

### 基本原則
実装ファイルとテストファイルの**厳密な1:1対応**を維持し、**実装の責務とテストの責務を完全一致**させる。

### 強制ルール

#### 1. ファイル対応と責務の原則
```text
実装ファイル1つ ⟷ テストファイル1つ ⟷ 同一責務

例:
✅ money.go     ⟷ money_test.go     : 基底クラス機能（乗算、等価性、加算）
✅ dollar.go    ⟷ dollar_test.go    : Dollarコンストラクタ機能のみ  
✅ franc.go     ⟷ franc_test.go     : Francコンストラクタ機能のみ
✅ exchange.go  ⟷ exchange_test.go  : Bank機能（レート、換算）
```

#### 2. 違反パターンと対処法

**❌ 違反例: 実装責務とテスト責務の不一致**
```text
// dollar.go: コンストラクタのみ実装
func NewDollar(amount int) Money { ... }

// dollar_test.go: 基底クラス機能もテスト（違反）
func TestDollarの乗算(t *testing.T) { ... }  // ← Timesはmoney.goの責務
```

**✅ 修正: 責務に応じたテスト配置**
```text
// dollar_test.go: コンストラクタ機能のみテスト
func TestDollarの作成(t *testing.T) { ... }

// money_test.go: 基底クラス機能をテスト
func TestMoneyの乗算(t *testing.T) { ... }
```

#### 3. テスト内容の責務分担

**各テストファイルの厳密な責務**:
- **money_test.go**: Money基底クラスの全機能（Equals, Times, Plus, Reduce等）
- **dollar_test.go**: NewDollar関数の動作のみ（作成テストのみ）
- **franc_test.go**: NewFranc関数の動作のみ（作成テストのみ）
- **exchange_test.go**: Bank機能（AddRate, Rate, Reduce等）

#### 4. 禁止事項

**絶対禁止**:
- 基底クラスメソッドを派生クラスのテストファイルでテストすること
- 「継承確認」を理由とした責務外テストの実装
- 「Dollar固有の動作」と称した基底クラス機能の重複テスト

#### 5. 重複コード判定

**許可される重複**: なし（設計が正しければ重複は発生しない）
**違反となる重複**: 異なるテストファイル間での同一機能テスト

#### 6. 修正手順

**責務違反発見時の対応**:
1. **即座修正**: 違反を発見したら他の作業を中断して即座に修正
2. **適切な移動**: テストを正しい責務のファイルに移動
3. **重複削除**: 移動後に重複テストを削除
4. **検証**: golangci-lintでdupl違反が0件であることを確認

#### 7. テスト命名とコメントルール

**テスト関数命名規則**:
```go
// TestEquality tests Money.Equals method behavior
// 期待: 同じ金額と通貨の場合は等しく、異なる場合は等しくないと判定される
func TestEquality(t *testing.T) {
    tests := []struct {
        name     string  // 必ず日本語で記述
        // ...
    }{
        {
            name: "同じ金額と通貨の場合、等しいと判定される",  // 日本語
            // ...
        },
    }
}
```

**必須要件**:
- テスト関数名は英語（例：`TestNewDollar`, `TestEquality`）
- テスト関数コメントは必須（何をテストし、何を期待するかを記述）
- t.Runのテスト名は日本語（実行時の可読性のため）

#### 8. レビューチェックポイント

**プルリクエスト作成前の必須確認**:
- [ ] 実装責務とテスト責務が完全一致している
- [ ] `golangci-lint run .`でdupl違反が0件である
- [ ] 各テストファイルの責務がコメントで明記されている
- [ ] 基底クラステストが適切なファイルに配置されている
- [ ] テスト関数名が英語で、適切なコメントが記述されている
- [ ] t.Runのテスト名が日本語で記述されている

**継続的な保守**:
- 新規実装ファイル作成時は責務に応じたテストファイルを作成
- 責務違反を発見したら即座に修正（後回し禁止）
- テスト命名規則に従って記述