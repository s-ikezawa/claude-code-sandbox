# CLAUDE.md

## 重要な制約事項

- **言語**: ユーザーとのやりとり、プログラム中のコメント、コミットメッセージ、Pull Requestの内容は日本語で記述する
- **CLIコマンド**: フルパスを利用して実行する

## プロジェクト構成

### フォルダ構造
```text
root/
├── src/                 # プログラミングコードを実装するフォルダ
├── docs/                # ドキュメントが格納されているフォルダ
│   └── specification.md # 仕様書
├── CLAUDE.md            # ClaudeCodeへの指示が書かれているファイル
└── README.md            # このプロジェクトのREADME
```

### 技術構成
- **プログラミング言語**: Go v1.24.4
- **静的解析**: golangci-lint (`golangci-lint run ./src/`)

## 開発ワークフロー

### 基本的な実装手順

1. **ブランチ準備**
   ```bash
   git switch main && git pull origin main
   git checkout -b [作業内容に沿ったブランチ名]
   ```

2. **TDD実装（TODO1つごとのサイクル）**
   **重要**: TODOリストから**1つずつ**取り出し、以下の手順を**必ず完了させてから次のTODOに進む**：
   
   **TODO単位の作業サイクル**：
   1. `TodoRead`でTODOリストを確認し、次の1つを選択
   2. 選択したTODOを`in_progress`にマーク
   3. テストコード作成（対応するTODOを明記）
      - **ファイル対応ルール**: 実装ファイル1つに対してテストファイル1つの厳密な1:1対応
        - 例: `user.go` → `user_test.go`、`money.go` → `money_test.go`
        - **禁止**: 複数の実装ファイルを1つのテストファイルでテストすること
        - **禁止**: 1つの実装ファイルを複数のテストファイルに分割すること
        - **統合ルール**: 関連する複数クラスが同一ファイルにある場合、そのテストも同一ファイルに統合
   4. テスト実行（失敗確認）
   5. 実装
   6. テスト成功確認
   7. **品質チェックと即時対応**:
      - golangci-lint実行（フルパス: `golangci-lint run ./src/`）
      - 検出されたissueは**即座に修正**（TODOリストに追加せず、その場で対応）
      - 全てのissueが解消されるまで次に進まない
      - issueが0件になったことを確認
   8. 現在のTODOを`completed`にマーク
   9. **必須コミット**: 1つのTODO完了ごとに必ずコミット（複数TODO分をまとめてコミットすることを禁止）
   10. 次のTODOへ（手順1に戻る）
   
   **禁止事項**：
   - 複数のTODOを同時に`in_progress`にすること
   - コミットせずに次のTODOに進むこと
   - 複数TODO分の変更を1つのコミットにまとめること

3. **品質確認と完了確認**
   - テストカバレッジ確認（目標：80%以上）
   - golangci-lint最終実行（問題がないことを確認）
   - **完了前最終チェック**: `TodoRead`ツールで全項目が`completed`であることを確認
   - **完了条件**: 全TODOリストが空になるか、全て`completed`状態になるまで作業継続
   - プルリクエスト作成

### 作業時の重要原則

- **CLIフルパス**: CLIツール利用時にパスを入力する場合はフルパスで入力
- **既存ファイル優先**: 新規ファイル作成より既存ファイル編集を優先
- **ファイル構成ルール**: 
  - 実装ファイルとテストファイルは必ず1:1対応
  - テストファイル名は実装ファイル名+`_test`（例: `user.go` → `user_test.go`）
  - 複数のテストファイルが同じ実装をテストしている場合は統合必須
  - 1つのテストファイルで複数の実装ファイルをテストしている場合は分割必須
- **TODOリスト活用**: 作業項目を明確にし、完了確認を徹底
- **TODOリスト必須ルール**: 
  - 各作業段階で`TodoRead`ツールを実行し進捗確認
  - 優先度に関係なく、TODOリストの全項目は必須作業として扱う
  - `priority:"low"`であってもリファクタリング含めて必ず完了させる
  - 作業完了報告前に全項目が`completed`であることを必ず確認
- **TODO単位作業の徹底**:
  - 1つのTODOごとに必ずコミット（まとめてコミット禁止）
  - 同時に複数TODOを`in_progress`にすることを禁止
  - 各TODO完了時にgolangci-lint実行とissue即時修正
  - コミットメッセージは完了したTODO内容を明記
- **コメントルール**: 仕様はメソッドコメントとして残し、リファクタリング経緯等の歴史的コメントは削除
- **テスト名ルール**: 
  - t.Runのテスト名は**必ず日本語**で記述
  - 条件と期待結果を含める（例：「5と10を加算した場合、15が返される」）
  - テーブル駆動テストでも同じルールを適用
  - 英語のテスト名は**一切禁止**
- **実装ステップ遵守**: 新機能・リファクタリング共にブランチ作成→テスト→実装の手順を適用
- **テストファースト**: 実装前にテストで期待する動作を先に定義
- **既存テスト保護**: 仕様変更せず内部実装のみ改善
- **品質即時対応ルール**:
  - TODO完了ごとにgolangci-lint実行を必須化
  - 検出されたissueは即座に修正（後回し禁止）
  - issue 0件確認後にのみコミット許可
  - 「リファクタリング対象」としてTODOリストに追加することを禁止

## リファクタリング指針

### 重複コード判定基準（50行未満）
duplicツールで検出されない小規模な重複に対する基準：
- **完全重複**: 同じロジックが複数箇所に存在する場合は統合
- **冗長ラッパー**: 型変換のみで追加ロジックがないメソッドは削除対象
- **不要メソッド**: 基底クラス機能と同等で価値を追加しないメソッドは削除

### 推奨golangci-lintツール
- **dupl**: 重複コード検出
- **gocyclo**: 循環的複雑度測定
- **cyclop**: 関数・パッケージ複雑度チェック

詳細設定は [README.md](./README.md#推奨ツールリファクタリング対象検出用) と `.golangci.yml` を参照。

## テストファイル対応強化ルール

### 基本原則
実装ファイルとテストファイルの**厳密な1:1対応**を維持することで、コードの保守性と可読性を確保する。

### 強制ルール

#### 1. ファイル対応の絶対原則
```text
実装ファイル1つ ⟷ テストファイル1つ

例:
✅ money.go     ⟷ money_test.go
✅ dollar.go    ⟷ dollar_test.go  
✅ franc.go     ⟷ franc_test.go
✅ exchange.go  ⟷ exchange_test.go
```

#### 2. 違反パターンと対処法

**❌ 違反例1: 複数実装ファイルを1つのテストファイルでテスト**
```text
dollar.go + franc.go → currency_test.go (違反)
```
**✅ 修正**: 各実装ファイルに対応するテストファイルを作成
```text
dollar.go → dollar_test.go
franc.go  → franc_test.go
```

**❌ 違反例2: 1つの実装ファイルを複数のテストファイルに分割**
```text
money.go → money_test.go + money_unit_test.go (違反)
```
**✅ 修正**: 1つのテストファイルに統合
```text
money.go → money_test.go
```

**❌ 違反例3: 他クラスのテストが混在**
```text
// dollar_test.go内でFrancのテストが混在（違反）
func TestFranc(t *testing.T) { ... }
```
**✅ 修正**: 適切なファイルに移動
```text
TestFranc → franc_test.go に移動
```

#### 3. テストファイル内容の責務分担

**各テストファイルの責務**:
- **money_test.go**: Money基底クラスの機能（基本操作、等価性判定、共通機能）
- **dollar_test.go**: Dollar専用機能（Dollar作成、Dollar固有動作）
- **franc_test.go**: Franc専用機能（Franc作成、Franc固有動作）
- **exchange_test.go**: Bank/為替レート機能（レート設定、換算、変換加算）

#### 4. 違反検出と修正手順

**検出方法**:
1. `golangci-lint run .`でdupl警告を確認
2. テストファイル名と実装ファイル名の対応を目視確認
3. 各テストファイル内の`func Test***`の命名を確認

**修正手順**:
1. **即座修正**: 違反を発見したら他の作業を中断して即座に修正
2. **分離・統合**: 適切なファイルにテストを移動/統合
3. **責務明確化**: コメントでファイルの責務を明記
4. **検証**: 修正後にテスト実行とlintチェックで確認

#### 5. 例外ルール

**許可される唯一の例外**:
- **統合テスト**: 複数クラス間の連携をテストする場合のみ、専用の統合テストファイル（例: `integration_test.go`）を作成可能
- **条件**: 単体テストは必ず各実装ファイルに対応するテストファイルで実施済みであること

#### 6. レビューチェックポイント

**プルリクエスト作成前の必須確認**:
- [ ] 全実装ファイルに対応するテストファイルが存在する
- [ ] テストファイル内に他クラスのテストが混在していない
- [ ] `golangci-lint run .`でdupl違反が0件である
- [ ] 各テストファイルの責務がコメントで明記されている

**継続的な保守**:
- 新規実装ファイル作成時は対応するテストファイルを同時作成
- リファクタリング時もファイル対応を維持
- 違反を発見したら即座に修正（後回し禁止）